# Example Home Assistant configuration for Marstek Battery System Integration
# This file shows optional configurations and examples

# Enable debug logging (optional)
logger:
  default: warning
  logs:
    custom_components.marstek: debug

# Example template sensors for Energy Dashboard
template:
  - sensor:
      # Battery charging energy (positive battery power only)
      - name: "Marstek Battery Charging Energy"
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set power = states('sensor.marstek_battery_power') | float(0) %}
          {{ [0, -power] | max }}
        
      # Battery discharging energy (negative battery power only)
      - name: "Marstek Battery Discharging Energy"
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set power = states('sensor.marstek_battery_power') | float(0) %}
          {{ [0, power] | max }}
      
      # Net grid power (positive = importing, negative = exporting)
      - name: "Marstek Net Grid Power"
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.marstek_grid_power') | float(0) }}
      
      # Battery health percentage
      - name: "Marstek Battery Health"
        unit_of_measurement: "%"
        state: >
          {% set current = states('sensor.marstek_battery_capacity') | float(0) %}
          {% set rated = states('sensor.marstek_battery_rated_capacity') | float(1) %}
          {{ ((current / rated) * 100) | round(1) if rated > 0 else 0 }}

# Example input helpers for automation settings
input_number:
  marstek_charge_rate:
    name: Marstek Charge Rate
    min: -3000
    max: 0
    step: 100
    unit_of_measurement: W
    icon: mdi:battery-charging
    
  marstek_discharge_rate:
    name: Marstek Discharge Rate
    min: 0
    max: 3000
    step: 100
    unit_of_measurement: W
    icon: mdi:battery-arrow-down

input_select:
  marstek_schedule_mode:
    name: Marstek Schedule Mode
    options:
      - "Off"
      - "Cheap Rate Charging"
      - "Peak Rate Discharging"
      - "Solar Optimization"
    icon: mdi:calendar-clock

input_datetime:
  marstek_charge_start:
    name: Charge Start Time
    has_date: false
    has_time: true
    
  marstek_charge_end:
    name: Charge End Time
    has_date: false
    has_time: true
    
  marstek_discharge_start:
    name: Discharge Start Time
    has_date: false
    has_time: true
    
  marstek_discharge_end:
    name: Discharge End Time
    has_date: false
    has_time: true

# Example utility meter for daily/monthly energy tracking
utility_meter:
  marstek_daily_solar:
    source: sensor.marstek_total_solar_energy
    cycle: daily
    
  marstek_daily_grid_import:
    source: sensor.marstek_total_grid_input_energy
    cycle: daily
    
  marstek_daily_grid_export:
    source: sensor.marstek_total_grid_output_energy
    cycle: daily
    
  marstek_monthly_solar:
    source: sensor.marstek_total_solar_energy
    cycle: monthly

# Example automations (also available in automations.yaml)
automation:
  # Charge during off-peak hours
  - id: marstek_cheap_rate_charging
    alias: "Marstek: Charge During Off-Peak"
    trigger:
      - platform: time
        at: input_datetime.marstek_charge_start
    condition:
      - condition: state
        entity_id: input_select.marstek_schedule_mode
        state: "Cheap Rate Charging"
      - condition: numeric_state
        entity_id: sensor.marstek_battery_state_of_charge
        below: 95
    action:
      - service: select.select_option
        target:
          entity_id: select.marstek_operating_mode
        data:
          option: "Passive"
      - delay:
          seconds: 2
      - service: number.set_value
        target:
          entity_id: number.marstek_passive_power
        data:
          value: "{{ states('input_number.marstek_charge_rate') | float }}"
      - service: notify.persistent_notification
        data:
          title: "Marstek Charging"
          message: "Started off-peak charging at {{ states('input_number.marstek_charge_rate') }}W"

  # Stop charging after off-peak hours
  - id: marstek_stop_cheap_charging
    alias: "Marstek: Stop Off-Peak Charging"
    trigger:
      - platform: time
        at: input_datetime.marstek_charge_end
    condition:
      - condition: state
        entity_id: input_select.marstek_schedule_mode
        state: "Cheap Rate Charging"
      - condition: state
        entity_id: select.marstek_operating_mode
        state: "Passive"
    action:
      - service: select.select_option
        target:
          entity_id: select.marstek_operating_mode
        data:
          option: "Auto"
      - service: notify.persistent_notification
        data:
          title: "Marstek Charging Complete"
          message: "Stopped off-peak charging, returned to Auto mode"

  # Discharge during peak hours
  - id: marstek_peak_discharge
    alias: "Marstek: Discharge During Peak"
    trigger:
      - platform: time
        at: input_datetime.marstek_discharge_start
    condition:
      - condition: state
        entity_id: input_select.marstek_schedule_mode
        state: "Peak Rate Discharging"
      - condition: numeric_state
        entity_id: sensor.marstek_battery_state_of_charge
        above: 20
    action:
      - service: select.select_option
        target:
          entity_id: select.marstek_operating_mode
        data:
          option: "Passive"
      - delay:
          seconds: 2
      - service: number.set_value
        target:
          entity_id: number.marstek_passive_power
        data:
          value: "{{ states('input_number.marstek_discharge_rate') | float }}"
      - service: notify.persistent_notification
        data:
          title: "Marstek Discharging"
          message: "Started peak-hour discharging at {{ states('input_number.marstek_discharge_rate') }}W"

  # Stop discharging after peak hours
  - id: marstek_stop_peak_discharge
    alias: "Marstek: Stop Peak Discharging"
    trigger:
      - platform: time
        at: input_datetime.marstek_discharge_end
    condition:
      - condition: state
        entity_id: input_select.marstek_schedule_mode
        state: "Peak Rate Discharging"
      - condition: state
        entity_id: select.marstek_operating_mode
        state: "Passive"
    action:
      - service: select.select_option
        target:
          entity_id: select.marstek_operating_mode
        data:
          option: "Auto"
      - service: notify.persistent_notification
        data:
          title: "Marstek Discharging Complete"
          message: "Stopped peak-hour discharging, returned to Auto mode"

  # Low battery protection
  - id: marstek_low_battery_protection
    alias: "Marstek: Low Battery Protection"
    trigger:
      - platform: numeric_state
        entity_id: sensor.marstek_battery_state_of_charge
        below: 20
    condition:
      - condition: state
        entity_id: select.marstek_operating_mode
        state: "Passive"
      - condition: numeric_state
        entity_id: number.marstek_passive_power
        above: 0
    action:
      - service: select.select_option
        target:
          entity_id: select.marstek_operating_mode
        data:
          option: "Auto"
      - service: notify.persistent_notification
        data:
          title: "Marstek Low Battery"
          message: "Battery below 20%, switched to Auto mode for protection"
          notification_id: "marstek_low_battery"

  # High temperature warning
  - id: marstek_high_temp_warning
    alias: "Marstek: High Temperature Warning"
    trigger:
      - platform: numeric_state
        entity_id: sensor.marstek_battery_temperature
        above: 45
    action:
      - service: notify.persistent_notification
        data:
          title: "⚠️ Marstek High Temperature"
          message: "Battery temperature is {{ states('sensor.marstek_battery_temperature') }}°C. Consider reducing charge/discharge rates."
          notification_id: "marstek_high_temp"

  # Solar optimization mode
  - id: marstek_solar_optimization
    alias: "Marstek: Solar Optimization"
    description: "Automatically charge when solar production exceeds consumption"
    trigger:
      - platform: state
        entity_id: sensor.marstek_solar_power
    condition:
      - condition: state
        entity_id: input_select.marstek_schedule_mode
        state: "Solar Optimization"
      - condition: numeric_state
        entity_id: sensor.marstek_solar_power
        above: 500  # At least 500W solar
      - condition: numeric_state
        entity_id: sensor.marstek_battery_state_of_charge
        below: 95
    action:
      - service: select.select_option
        target:
          entity_id: select.marstek_operating_mode
        data:
          option: "AI"  # Let AI optimize solar usage

# Example scripts
script:
  marstek_force_charge:
    alias: "Marstek: Force Charge"
    sequence:
      - service: select.select_option
        target:
          entity_id: select.marstek_operating_mode
        data:
          option: "Passive"
      - delay:
          seconds: 2
      - service: number.set_value
        target:
          entity_id: number.marstek_passive_power
        data:
          value: -2000  # Charge at 2000W
    mode: single

  marstek_force_discharge:
    alias: "Marstek: Force Discharge"
    sequence:
      - service: select.select_option
        target:
          entity_id: select.marstek_operating_mode
        data:
          option: "Passive"
      - delay:
          seconds: 2
      - service: number.set_value
        target:
          entity_id: number.marstek_passive_power
        data:
          value: 1500  # Discharge at 1500W
    mode: single

  marstek_return_to_auto:
    alias: "Marstek: Return to Auto Mode"
    sequence:
      - service: select.select_option
        target:
          entity_id: select.marstek_operating_mode
        data:
          option: "Auto"
    mode: single
